% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/did_funcs.R
\name{fetwfe_core}
\alias{fetwfe_core}
\title{Core Estimation Logic for Fused Extended Two-Way Fixed Effects}
\usage{
fetwfe_core(
  X_ints,
  y,
  in_sample_counts,
  N,
  T,
  d,
  p,
  num_treats,
  first_inds,
  indep_counts = NA,
  sig_eps_sq = NA,
  sig_eps_c_sq = NA,
  lambda.max = NA,
  lambda.min = NA,
  nlambda = 100,
  q = 0.5,
  verbose = FALSE,
  alpha = 0.05,
  add_ridge = FALSE
)
}
\arguments{
\item{X_ints}{The design matrix with all fixed effects, covariates, treatment
dummies, and their interactions, as produced by \code{prepXints}.}

\item{y}{The centered response vector, as produced by \code{prepXints}.}

\item{in_sample_counts}{An integer vector named with cohort identifiers
(including "Never_treated"), indicating the number of units in each cohort
within the data used for estimation.}

\item{N}{The number of unique units.}

\item{T}{The number of unique time periods.}

\item{d}{The number of covariates.}

\item{p}{The total number of columns in \code{X_ints} (total parameters).}

\item{num_treats}{The total number of unique treatment effect parameters.}

\item{first_inds}{A numeric vector indicating the starting column index for
each cohort's first treatment effect within the treatment effect block.}

\item{indep_counts}{(Optional) An integer vector of counts for how many units
appear in the untreated cohort plus each of the other \code{R} cohorts, derived
from an independent dataset. Used for asymptotically exact standard errors for
the ATT. Default is \code{NA}.}

\item{sig_eps_sq}{(Optional) Numeric; the known variance of the observation-level
IID noise. If \code{NA}, it will be estimated. Default is \code{NA}.}

\item{sig_eps_c_sq}{(Optional) Numeric; the known variance of the unit-level IID
noise (random effects). If \code{NA}, it will be estimated. Default is \code{NA}.}

\item{lambda.max}{(Optional) Numeric; the maximum \code{lambda} penalty parameter for
the bridge regression grid search. If \code{NA}, \code{grpreg} selects it. Default is \code{NA}.}

\item{lambda.min}{(Optional) Numeric; the minimum \code{lambda} penalty parameter.
If \code{NA}, \code{grpreg} selects it. Default is \code{NA}.}

\item{nlambda}{(Optional) Integer; the number of \code{lambda} values in the grid.
Default is 100.}

\item{q}{(Optional) Numeric; the power of the Lq penalty for fusion regularization
(0 < q <= 2). \code{q=0.5} is default, \code{q=1} is lasso, \code{q=2} is ridge.
Default is 0.5.}

\item{verbose}{Logical; if \code{TRUE}, prints progress messages. Default is \code{FALSE}.}

\item{alpha}{Numeric; significance level for confidence intervals (e.g., 0.05 for
95\% CIs). Default is 0.05.}

\item{add_ridge}{(Optional) Logical; if \code{TRUE}, adds a small L2 penalty to
the untransformed coefficients to stabilize estimation. Default is \code{FALSE}.}
}
\value{
A list containing detailed estimation results:
\item{in_sample_att_hat}{Estimated overall ATT using in-sample cohort probabilities.}
\item{in_sample_att_se}{Standard error for \code{in_sample_att_hat}.}
\item{in_sample_att_se_no_prob}{SE for \code{in_sample_att_hat} ignoring variability from estimating cohort probabilities.}
\item{indep_att_hat}{Estimated overall ATT using \code{indep_counts} cohort probabilities (NA if \code{indep_counts} not provided).}
\item{indep_att_se}{Standard error for \code{indep_att_hat} (NA if not applicable).}
\item{catt_hats}{A named vector of estimated CATTs for each cohort.}
\item{catt_ses}{A named vector of SEs for \code{catt_hats} (NA if \code{q >= 1}).}
\item{catt_df}{A data.frame summarizing CATTs, SEs, and confidence intervals.}
\item{theta_hat}{The vector of estimated coefficients in the \emph{transformed} (fused) space, including the intercept as the first element.}
\item{beta_hat}{The vector of estimated coefficients in the \emph{original} space (after untransforming \code{theta_hat}, excluding intercept).}
\item{treat_inds}{Indices in \code{beta_hat} corresponding to base treatment effects.}
\item{treat_int_inds}{Indices in \code{beta_hat} corresponding to treatment-covariate interactions.}
\item{cohort_probs}{Estimated cohort probabilities conditional on being treated, from \code{in_sample_counts}.}
\item{indep_cohort_probs}{Estimated cohort probabilities from \code{indep_counts} (NA if not provided).}
\item{sig_eps_sq}{The (possibly estimated) variance of observation-level noise.}
\item{sig_eps_c_sq}{The (possibly estimated) variance of unit-level random effects.}
\item{lambda.max}{The maximum lambda value used in \code{grpreg}.}
\item{lambda.max_model_size}{Model size for \code{lambda.max}.}
\item{lambda.min}{The minimum lambda value used in \code{grpreg}.}
\item{lambda.min_model_size}{Model size for \code{lambda.min}.}
\item{lambda_star}{The lambda value selected by BIC.}
\item{lambda_star_model_size}{Model size for \code{lambda_star}.}
\item{X_ints}{The original input design matrix from \code{prepXints}.}
\item{y}{The original input centered response vector from \code{prepXints}.}
\item{X_final}{The design matrix after fusion transformation and GLS weighting.}
\item{y_final}{The response vector after GLS weighting.}
\item{N, T, R, d, p}{Dimensions used in estimation.}
}
\description{
This function implements the core estimation steps of the FETWFE methodology.
It takes a pre-processed design matrix and response, applies transformations
for fusion penalties, handles variance components, performs bridge regression,
selects the optimal penalty via BIC, and calculates treatment effects and
their standard errors.
}
\details{
The function executes the following main steps:
\enumerate{
\item \strong{Input Checks:} Validates the provided parameters.
\item \strong{Coordinate Transformation:} Calls \code{transformXintImproved} to transform
\code{X_ints} into \code{X_mod}. This transformation allows a standard bridge
regression penalty on \code{X_mod} to achieve the desired fusion penalties
on the original coefficients.
\item \strong{Variance Component Handling:}
\itemize{
\item If \code{sig_eps_sq} or \code{sig_eps_c_sq} are \code{NA}, \code{estOmegaSqrtInv} is
called to estimate them from the data using a fixed-effects ridge
regression.
\item Constructs the covariance matrix \code{Omega} and its inverse square
root \code{Omega_sqrt_inv}.
\item Pre-multiplies \code{y} and \code{X_mod} by \code{sqrt(sig_eps_sq) * Omega_sqrt_inv}
(via Kronecker product) to obtain \code{y_final} and \code{X_final}, effectively
performing a GLS transformation.
}
\item \strong{Optional Ridge Penalty:} If \code{add_ridge} is \code{TRUE}, \code{X_final_scaled}
(scaled version of \code{X_final}) and \code{y_final} are augmented to add an L2
penalty on the \emph{original} (untransformed) coefficient scale. This involves
using \code{genFullInvFusionTransformMat} to get the inverse of the overall
fusion transformation matrix.
\item \strong{Cohort Probabilities:} Calculates cohort membership probabilities
conditional on being treated, using \code{in_sample_counts} and \code{indep_counts}
if available.
\item \strong{Bridge Regression:} Fits a bridge regression model using
\code{grpreg::gBridge} on \code{X_final_scaled} and \code{y_final} with the specified \code{q}
and lambda sequence.
\item \strong{Coefficient Selection (BIC):} Calls \code{getBetaBIC} to select the
optimal \code{lambda} using BIC and retrieve the corresponding estimated
coefficients (\code{theta_hat} in the transformed space).
\item \strong{Handle Zero-Feature Case:} If BIC selects a model with zero features,
treatment effects are set to zero.
\item \strong{Coefficient Untransformation:} Calls \code{untransformCoefImproved} to
transform \code{theta_hat} back to the original coefficient space, yielding
\code{beta_hat}. If \code{add_ridge} was true, \code{beta_hat} is scaled.
\item \strong{Treatment Effect Calculation:}
\itemize{
\item Extracts cohort-specific average treatment effects (CATTs) from
\code{beta_hat}.
\item Calls \code{getCohortATTsFinal} to calculate CATT point estimates,
standard errors (if \code{q < 1}), and confidence intervals. This involves
computing the Gram matrix and related quantities.
}
\item \strong{Overall ATT Calculation:} Calls \code{getTeResults2} to calculate the
overall average treatment effect on the treated (ATT) and its standard
error, using both in-sample probabilities and independent probabilities
if \code{indep_counts} were provided.
}
The standard errors for CATTs are asymptotically exact. For ATT, if
\code{indep_counts} are provided, the SE is asymptotically exact; otherwise, it's
asymptotically conservative (if \code{q < 1}).
}
\keyword{internal}

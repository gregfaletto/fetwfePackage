---
title: "fetwfe: A Package for Fused Extended Two-Way Fixed Effects"
author: "Gregory Faletto"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    output_file: "FETWFE_vignette.html"
vignette: >
  %\VignetteIndexEntry{fetwfe: A Package for Fused Extended Two-Way Fixed Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Difference-in-differences (DiD) methods have become a workhorse in applied research to estimate causal effects when policies or treatments are adopted in a staggered manner. However, the canonical two‐way fixed effects (TWFE) estimator can be biased in settings with staggered adoptions. In his recent work, Wooldridge (2021) introduced the extended TWFE estimator that augments the baseline model with many additional parameters in order to target unbiased estimands. The downside, however, is that such models often sacrifice efficiency.

In our package I implement the **FETWFE** (Fused Extended Two-Way Fixed Effects) estimator. This estimator applies a machine learning penalty—specifically, sparse fusion (or “bridge”) penalties—to automatically select data‐driven restrictions among the many parameters in the extended TWFE model. Under appropriate sparsity conditions, FETWFE is shown to identify the “correct” restrictions with probability tending to one, thereby reducing the variance of the treatment effect estimates while retaining asymptotic unbiasedness and consistency.

For a complete treatment of the methodology, see the paper:

> **Fused Extended Two-Way Fixed Effects for Difference-in-Differences With Staggered Adoptions**  
> *Gregory Faletto, University of Southern California*  
> (A preprint version is available on arXiv.)

# Methodology Overview

The FETWFE approach builds on the following key ideas:

- **Extended TWFE model:** In the extended model each cohort and each post-treatment time period gets its own parameter for the treatment effect. This allows the estimator to capture heterogeneous effects across both cohorts and time.
- **Fusion penalties:** By imposing an ℓ<sub>q</sub> (bridge) penalty on the differences between treatment effect parameters, FETWFE “fuses” together coefficients that are close, thereby effectively reducing the model’s complexity.
- **Automatic restriction selection:** Unlike ad hoc restrictions, FETWFE uses a single tuning parameter (selected via BIC or cross-validation) to determine which coefficients should be pooled, thereby retaining asymptotic properties (consistency, oracle property, and asymptotic normality) under appropriate sparsity assumptions.

A schematic diagram (see Figure 1 in the paper) illustrates which treatment effect parameters \(\hat{\tau}_{rt}\) are fused together. (For instance, treatment effects within the same cohort and initial treatment effects across adjacent cohorts are shrunk toward one another.)

# Package Usage

The package provides a single exported function, `fetwfe()`, which implements the FETWFE estimator. Its primary arguments include:

- **`pdata`**: A data frame in panel (long) format.
- **`time_var`**: A character string specifying the name of the time period variable.
- **`unit_var`**: A character string specifying the unit (e.g. state, firm) variable.
- **`treatment`**: A character string specifying the treatment indicator variable (which must be an absorbing binary indicator).
- **`covs`**: A character vector of covariate names (typically time-invariant or the pre-treatment values).
- **`response`**: A character string specifying the response (outcome) variable.
- **Additional tuning parameters:** such as the tuning parameter for the bridge penalty (controlled via argument `q`) and options for verbosity, standard error calculation, and so on.

The function returns a list containing, for example, the estimated overall average treatment effect, cohort-specific treatment effects, standard errors (when available), and various diagnostic quantities.

## A Basic Example

Below is an example of how to use `fetwfe()` on a panel data set. (In this example I use the `divorce` data from the `bacondecomp` package; you may substitute any appropriate panel data.)

```{r}
# Load the necessary packages
library(fetwfe)       # your package with the FETWFE estimator
library(bacondecomp)  # for the example data

# Load the example data
data(divorce)

# Suppose we wish to estimate the effect of a policy (here represented by the variable "changed")
# on the response "suiciderate_elast_jag" using covariates "murderrate", "lnpersinc", and "afdcrolls".
# Assume that:
# - 'year' is the time period variable (as an integer),
# - 'st' is the unit identifier,
# - 'changed' is the treatment indicator (with 0 = untreated, 1 = treated),
# - We only use observations that are not treated in the first period.

# Call the estimator (note: adjust variable names as needed)
result <- fetwfe(
    pdata=divorce[divorce$sex == 2, ],
    time_var="year",
    unit_var="st",
    treatment="changed",
    covs=c("murderrate", "lnpersinc", "afdcrolls"),
    response="suiciderate_elast_jag",
    q=0.5 # fusion penalty parameter (q in (0,2])
    )

# Display the overall average treatment effect
cat("Overall ATT estimate:", result$att_hat, "\n")

# If available, display the conservative 95% confidence interval
if (!is.na(result$att_se)) {
  se <- result$att_se
  lower <- result$att_hat - qnorm(0.975) * se
  upper <- result$att_hat + qnorm(0.975) * se
  cat("95% Confidence Interval: (", lower, ", ", upper, ")\n")
}

# Display the cohort-specific treatment effects as a data frame
print(result$catt_df)
```

When you run this code, the function internally performs all necessary data transformations, applies the fusion penalty via a bridge regression (using the `grpreg` package), and returns the estimated treatment effects along with diagnostic information.

# Empirical Application

To illustrate FETWFE in an empirical context, we now reproduce an analysis using data from Stevenson and Wolfers (2006) on the impact of no-fault divorce laws on female suicide rates. (See also Goodman-Bacon (2021) for an alternative analysis.) In our application, the panel data consist of state-level observations over 33 years. After removing states that received treatment in the first period, we are left with 42 states, of which 5 are never treated and 12 cohorts adopt treatment at various times.

Time-varying covariates (such as the state homicide rate, logged personal income, and welfare participation) are included as controls (using the pre-treatment values). In our example, we use FETWFE with \(q = 0.5\) to estimate the marginal average treatment effects. For instance:

```{r}
# Load the divorce data (from bacondecomp package)
data(divorce)

# (For illustration: filter out units treated in the first period if necessary)
# In our empirical application, suppose we remove states treated at t = 1.
# This step is handled internally by the function, but you can also pre-filter your data.

# Call the FETWFE estimator with appropriate parameters.
# (Assume that the following variable names correspond to the variables described in the paper.)
result_emp <- fetwfe(
  pdata=divorce[divorce$sex == 2, ],
  time_var="year",
  unit_var="st",
  treatment="changed",
  covs=c("murderrate", "lnpersinc", "afdcrolls"),
  response="suiciderate_elast_jag",
  q=0.5
)

# Print the overall average treatment effect (ATT)
cat("Estimated overall ATT (percent change):", 100 * result_emp$att_hat, "\n")

# Print the cohort-specific treatment effect estimates
print(result_emp$catt_df)
```

For the data application, our estimates yielded an overall ATT of approximately –3.76% change in the female suicide rate, similar to other estimates in the literature. In addition, the output table (stored in `result_emp$catt_df`) displays the cohort-specific estimates. (Note that standard errors for the individual cohort estimates are less reliable when the number of units per cohort is small.)

Below is an excerpt of the table produced by our estimator:

| Cohort | Estimated TE |   SE   | ConfIntLow | ConfIntHigh |
|:------:|:------------:|:------:|:----------:|:-----------:|
| 1969   |  0%          |   —    |     —      |     —       |
| 1970   | -40.142%     |   —    |     —      |     —       |
| 1971   |  0%          |   —    |     —      |     —       |
| ⋮      |   ⋮          |   ⋮    |     ⋮      |     ⋮       |

*Table: Cohort average treatment effect estimates.*

# Simulated Data Example

In addition to real data applications, you can also experiment with FETWFE on simulated data. The example below simulates a balanced panel with 60 time periods, 30 individuals, and 5 waves of treatment. In the simulation, each individual is assigned a random cohort (which determines the timing of treatment) and three time-invariant covariates are generated. The response variable is constructed so that, after treatment, its evolution depends on a treatment effect (which varies by cohort) and a linear trend, plus the covariates and some random noise.

Below is the complete code for simulating the data, converting it into the required pdata format, and running the `fetwfe()` function.

```{r}
# Set seed for reproducibility
set.seed(123456L)

# 60 time periods, 30 individuals, and 5 waves of treatment
tmax = 60; imax = 30; nlvls = 5

dat = 
  expand.grid(time = 1:tmax, id = 1:imax) |>
  within({
    
    # Generate time-invariant covariates
    cov1 = rep(runif(imax, 0, 1), each = tmax)  # Random uniform values (0, 1) per individual
    cov2 = rep(sample(1:5, imax, replace = TRUE), each = tmax)  # Random categorical values (1-5) per individual
    cov3 = rep(rnorm(imax, mean = 0, sd = 1), each = tmax)  # Random Gaussian values (mean=0, sd=1) per individual
    
    # Initialize columns
    cohort      = NA
    effect      = NA
    first_treat = NA
    
    for (chrt in 1:imax) {
      cohort = ifelse(id==chrt, sample.int(nlvls, 1), cohort)
    }
    
    for (lvls in 1:nlvls) {
      effect      = ifelse(cohort==lvls, sample(2:10, 1), effect)
      first_treat = ifelse(cohort==lvls, sample(1:(tmax+20), 1), first_treat)
    }
    
    first_treat = ifelse(first_treat>tmax, Inf, first_treat)
    treat       = time >= first_treat
    rel_time    = time - first_treat
    y           = id + time + ifelse(treat, effect*rel_time, 0) + cov1 + cov2 + cov3 + rnorm(imax*tmax)
    
    rm(chrt, lvls, cohort, effect)
  })

head(dat)
```

The simulated data (`dat`) now has columns for time, id, covariates (`cov1`, `cov2`, `cov3`), a treatment indicator (`treat`), and a response variable (`y`). Next, we convert this data into the panel data format required by `fetwfe()`.

```{r}
# Specify column names for the pdata format
time_var <- "time"       # Column for the time period
unit_var <- "unit"       # Column for the unit identifier
treatment <- "treated"   # Column for the treatment dummy indicator
covs <- c("cov1", "cov2", "cov3")  # Columns for covariates
response <- "response"   # Column for the response variable

# Convert the dataset
pdata <- dat |>
  dplyr::mutate(
    # Rename id to unit and convert to character
    {{ unit_var }} := as.character(id),
    # Ensure treatment dummy is 0/1
    {{ treatment }} := as.integer(treat),
    # Rename y to response
    {{ response }} := y
  ) |>
  dplyr::select(
    {{ time_var }}, {{ unit_var }}, {{ treatment }}, dplyr::all_of(covs), {{ response }}
  ) 

# Preview the resulting pdata dataframe
head(pdata)
```

Now that `pdata` is properly formatted, we run the FETWFE estimator on the simulated data.

```{r}

# Run the FETWFE estimator on the simulated data
result <- fetwfe(
  pdata = pdata,              # The panel dataset
  time_var = "time",          # The time variable
  unit_var = "unit",          # The unit identifier
  treatment = "treated",      # The treatment dummy indicator
  covs = c("cov1", "cov2", "cov3"),  # Covariates
  response = "response",      # The response variable
  q = 0.5                    # The L_q penalty for fusion regularization
)

# Display the overall average treatment effect estimate
cat("Estimated Overall ATT:", result$att_hat, "\n")
```

When you run this code, the function internally performs all the necessary data preparation, applies the fusion penalty via a bridge regression (using the `grpreg` package), and returns a list with overall and cohort-specific treatment effect estimates, standard errors (if available), and additional diagnostics.

This example shows how you can simulate panel data with treatment heterogeneity, convert it to the required format, and apply the FETWFE estimator to recover treatment effect estimates.

# Conclusion

This vignette has introduced the FETWFE estimator—a fusion-penalized extended two-way fixed effects method—for estimating treatment effects in panel data with staggered adoptions. By automatically fusing together similar treatment effects across cohorts and time periods, FETWFE reduces model complexity while preserving desirable asymptotic properties. In our examples, we demonstrated how to use the single function `fetwfe()` (or `fewtfe()` as you may name it) to obtain both overall and cohort-specific treatment effect estimates.

I encourage users to explore further the detailed theoretical properties (consistency, oracle property, asymptotic normality) presented in the accompanying paper. Feedback and suggestions are welcome!

# References

- Borusyak, K., Jaravel, X., & Spiess, J. (2024). Revisiting difference-in-differences. *Journal of Econometrics*.
- Callaway, B., & Sant’Anna, P. H. (2021). Difference-in-Differences with multiple time periods. *Journal of Econometrics*.
- Goodman-Bacon, A. (2021). Difference-in-Differences with variation in treatment timing. *Journal of Econometrics*.
- Huang, J., Horowitz, J. L., & Wei, F. (2008). Asymptotic properties of bridge estimators in sparse high-dimensional regression models. *Annals of Statistics*.
- Pesaran, M. H. (2015). *Time Series and Panel Data Econometrics*. Oxford University Press.
- Sun, L., & Abraham, S. (2021). Estimating dynamic treatment effects in event studies with heterogeneous treatment effects. *Journal of Econometrics*.
- Tibshirani, R. (1996). Regression shrinkage and selection via the lasso. *Journal of the Royal Statistical Society: Series B*.
- Tibshirani, R., Saunders, M., Rosset, S., Zhu, J., & Knight, K. (2005). Sparsity and smoothness via the fused lasso. *Journal of the Royal Statistical Society: Series B*.
- Wooldridge, J. M. (2021). Two-way fixed effects estimators with heterogeneous treatment effects. *Journal of Econometrics*.


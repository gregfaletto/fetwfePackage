---
title: "Simulation Vignette for FETWFE: From Coefficients to True Treatment Effects"
author: "Gregory Faletto"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    output_file: "FETWFE_Simulation_Vignette.html"
vignette: >
  %\VignetteIndexEntry{FETWFE Simulation Vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_chunk$set(echo = TRUE)

```

```{r setup}
# Load necessary libraries
library(dplyr)
library(fetwfe)
```

# Introduction

This vignette demonstrates how to perform simulation studies using the simulation functions provided in the `{fetwfe}` package. In particular, I will show how to:
  
- Generate a coefficient object with `genCoefs()`,
- Simulate a panel data set with `simulateData()`,
- Run the FETWFE estimator on the simulated data using `fetwfeWithSimulatedData()`, and
- Extract the true treatment effects with `getTes()`.

# Simulation Workflow Using Piping

Below we create a complete simulation pipeline.

## Step 1: Generate Simulation Coefficients

The `genCoefs()` function creates an object of class `"FETWFE_coefs"` which includes a coefficient vector along with the simulation parameters. For this example, we set:
  
- **R** (number of treated cohorts) to 5,
- **T** (number of time periods) to 30,
- **d** (number of covariates) to 12,
- **density** to 0.1 (controls sparsity), and
- **eff_size** to 2.

```{r}
# Generate the coefficient object for simulation
sim_coefs <- genCoefs(R = 5, T = 30, d = 12, density = 0.1, eff_size = 2, seed = 101)
```

## Step 2: Simulate Panel Data

Next, we simulate the data using the generated coefficient object with the `simulateData()` function. Here we specify:

- **N** (number of units) as 120,
- **sig_eps_sq** (observation-level noise variance) as 5,
- **sig_eps_c_sq** (unit-level noise variance) as 5, and
- use the default `"gaussian"` distribution for the covariates.

```{r}
# Simulate panel data based on the coefficients
sim_data <- simulateData(
  sim_coefs,
  N = 120,
  sig_eps_sq = 5,
  sig_eps_c_sq = 5,
  distribution = "gaussian"
  )
```

The dataframe is stored in `sim_data$pdata`, so we can take a quick look:

```{r}
head(sim_data$pdata)
```

## Step 3: Run the FETWFE Estimator on Simulated Data

We then run the estimator on the simulated data using `fetwfeWithSimulatedData()`. (We could manually unpack `sim_data` and pass the arguments appropriately to `fewtfe()`, but `fetwfeWithSimulatedData()` is a wrapper that takes care of this for us.)

```{r}
# Run the estimator using piping
result <- fetwfeWithSimulatedData(sim_data)
```

We can now extract the results from `result` in the same way that we can with the standard `fetwfe()` function.

```{r}
# Display the estimated overall average treatment effect
cat("Estimated Overall ATT from Simulated Data:", result$att_hat, "\n")

# Calculate a 95% confidence interval
low_att <- result$att_hat - qnorm(1 - 0.05 / 2) * result$att_se
high_att <- result$att_hat + qnorm(1 - 0.05 / 2) * result$att_se

cat("Estimated Overall ATT from Simulated Data:")
cat(c(low_att, high_att))

# Print the estimated cohort-specific treatment effects
cat("Estimated cohort-specific treatment effects:")
result$catt_df

```

## Step 4: Extract True Treatment Effects

For comparison, we can compute the true treatment effects using the original coefficient object. The `getTes()` function extracts both the overall average treatment effect and the cohort-specific effects.

```{r}
# Extract the true treatment effects
true_tes <- getTes(sim_coefs)

# Print the true overall treatment effect
cat("True Overall ATT:", true_tes$att_true, "\n")

# Print the cohort-specific treatment effects
print(true_tes$actual_cohort_tes)
```

We can use this to calculate metrics to evaluate our estimated treatment effect, like the squared error:

```{r}
squared_error <- (result$att_hat - true_tes$att_true)^2

cat("Squared error of ATT estimate:", squared_error, "\n")
```

## Combining the Workflow in One Pipeline

You can also chain the simulation functions together with the pipe operator. For example, the following code generates the coefficients, simulates the data, and runs the estimator all in one pipeline:

```{r}
# A fully piped workflow from coefficient generation to estimation

coefs <- genCoefs(R = 5, T = 30, d = 12, density = 0.1, eff_size = 2, seed = 2025)

result_piped <- coefs |>
  simulateData(N = 120, sig_eps_sq = 5, sig_eps_c_sq = 5) |>
  fetwfeWithSimulatedData()

cat("Estimated Overall ATT from piped workflow:", result_piped$att_hat, "\n")

true_tes_piped <- coefs |> getTes()

# Print the true overall treatment effect
cat("True Overall ATT:", true_tes_piped$att_true, "\n")

# Print the squared estimation error
squared_error_piped = (result_piped$att_hat - true_tes_piped$att_true)^2

cat("Squared estimation error:", squared_error_piped, "\n")
```

# Conclusion

In this vignette, we walked through how to use the simulation functions in the `{fetwfe}` package. This pipeline makes it easy to iterate on simulation studies and assess the performance of the estimator under different conditions.

For additional details or help, please refer to the package documentation or contact me.
